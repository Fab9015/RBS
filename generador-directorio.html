<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <title>Dashboard de Directorio</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <style>
        body {
            font-family: 'Lato', sans-serif;
            background: #fdfaf5;
            color: #5c4033;
            margin: 0;
        }

        header {
            background: #a1b27a;
            color: #fff;
            padding: 1em;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }

        header h1 {
            margin: 0;
        }

        header .header-buttons {
            display: flex;
            gap: 10px;
        }

        header button {
            background: #fff;
            color: #5c4033;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
        }

        header button:hover {
            background: #eee;
        }

        .toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1em;
            flex-wrap: wrap;
        }

        .toolbar input,
        .toolbar select {
            padding: 6px;
            border: 1px solid #ccc;
            border-radius: 6px;
            margin-right: 8px;
        }

        /* Ajuste: no dar width fijo a todos los inputs */
        .toolbar input[type="text"],
        .toolbar select {
            width: auto;
        }

        /* Estilo específico para checkbox */
        .modal-content input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .container {
            display: flex;
            flex-wrap: wrap;
            padding: 1em;
        }

        .card {
            background: #fff;
            border: 2px solid #a1b27a;
            border-radius: 8px;
            width: 280px;
            margin: 1em;
            padding: 1em;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            position: relative;
            min-height: 380px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .card img {
            width: 100%;
            height: 150px;
            object-fit: contain;
        }

        .card h3 {
            margin: 0.5em 0;
        }

        .card p.relevante-label {
            min-height: 20px;
        }

        .card .actions {
            display: flex;
            justify-content: space-between;
            margin-top: auto;
        }

        .card button {
            flex: 1;
            margin: 0 4px;
            padding: 6px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
        }

        .edit-btn {
            background: #8fa76a;
            color: #fff;
        }

        .delete-btn {
            background: #d9534f;
            color: #fff;
        }

        .edit-btn:hover {
            background: #7a935d;
        }

        .delete-btn:hover {
            background: #c9302c;
        }

        .category-tag {
            display: inline-block;
            background: #a1b27a;
            color: #fff;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.8em;
            position: absolute;
            top: 8px;
            right: 8px;
        }

        /* Sidebar */
        .sidebar {
            padding: 1em;
            border-top: 2px solid #a1b27a;
            background: #fff;
        }

        .sidebar h2 {
            margin-top: 0;
        }

        .sidebar .cat-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 4px 0;
            padding: 4px;
            border-bottom: 1px solid #eee;
        }

        .sidebar .cat-row button {
            margin-left: 4px;
            padding: 4px 6px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8em;
        }

        .sidebar .edit-cat {
            background: #8fa76a;
            color: #fff;
        }

        .sidebar .delete-cat {
            background: #d9534f;
            color: #fff;
        }

        .sidebar .add-cat-btn {
            background: #fff;
            color: #5c4033;
            border: none;
            padding: 6px 10px;
            border-radius: 6px;
            cursor: pointer;
            float: right;
            margin-bottom: 8px;
        }

        .sidebar .add-cat-btn:hover {
            background: #eee;
        }

        /* Paginación */
        #paginacion {
            text-align: center;
            margin: 1em;
        }

        #paginacion button {
            margin: 0 2px;
            padding: 6px 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        #paginacion span {
            margin: 0 4px;
        }

        /* JSON output */
        .json-section {
            padding: 1em;
            background: #fff;
            border-top: 2px solid #a1b27a;
        }

        .json-section textarea {
            width: 100%;
            height: 250px;
            font-family: monospace;
            margin-top: 1em;
        }

        .json-section button {
            background: #fff;
            color: #5c4033;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            margin-right: 6px;
        }

        .json-section button:hover {
            background: #eee;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: #fff;
            padding: 1.5em;
            border-radius: 8px;
            width: 400px;
            max-width: 90%;
        }

        .modal-content label {
            display: block;
            margin-top: 0.5em;
        }

        .modal-content input,
        .modal-content select {
            width: 100%;
            padding: 6px;
            margin-top: 4px;
            border: 1px solid #ccc;
            border-radius: 6px;
        }

        .modal-content .relevante {
            display: flex;
            align-items: center;
            justify-content: flex-start;
            margin-top: 0.5em;
            gap: 8px;
        }

        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            margin-top: 1em;
        }

        .modal-actions button {
            padding: 8px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
        }

        .modal-actions .save-btn {
            background: #a1b27a;
            color: #fff;
        }

        .modal-actions .cancel-btn {
            background: #ccc;
            color: #333;
        }

        /* Responsive */
        @media(max-width:600px) {
            .card {
                width: 100%;
            }

            .toolbar {
                flex-direction: column;
                gap: 0.5em;
            }
        }
    </style>
</head>

<body>
    <header>
        <h1>Dashboard de Directorio</h1>
        <div class="header-buttons">
            <button onclick="openModal()">+ Crear trabajador</button>
            <button onclick="downloadJSON()">Descargar archivo</button>
            <button onclick="copiarJSON()">Copiar datos</button>
        </div>
    </header>

    <!-- Herramientas -->
    <div class="toolbar">
        <div>
            <input id="search-input" placeholder="Buscar por nombre..." oninput="renderCards()">
            <select id="orden-select" onchange="ordenarTrabajadores(this.value)">
                <option value="az">Ordenar A-Z</option>
                <option value="za">Ordenar Z-A</option>
            </select>
        </div>
        <label>
            Mostrar:
            <select onchange="porPagina=parseInt(this.value);paginaActual=1;renderCards()">
                <option value="6">6</option>
                <option value="12">12</option>
                <option value="24">24</option>
            </select>
        </label>
    </div>

    <!-- Cards -->
    <div class="container" id="cards-container"></div>

    <!-- Paginación -->
    <div id="paginacion"></div>

    <!-- Sidebar -->
    <div class="sidebar">
        <h2>Categorías
            <button class="add-cat-btn" onclick="addCategoria()">+ Agregar categoría</button>
        </h2>
        <div id="categorias-list"></div>

        <h2>Búsquedas relevantes</h2>
        <div id="busquedas-list"></div>
    </div>

    <!-- JSON generado -->
    <div class="json-section">
        <h2>JSON generado</h2>
        <textarea id="output" readonly></textarea>
    </div>
    <!-- Modal -->
    <div class="modal" id="modal">
        <div class="modal-content">
            <h2 id="modal-title">Agregar trabajador</h2>
            <label>Nombre: <input id="nombre"></label>
            <label>Teléfono: <input id="telefono"></label>
            <label>Correo: <input id="correo"></label>
            <label>Categoría:
                <select id="categoria"></select>
            </label>
            <div class="relevante">
                <label for="relevante">Contacto relevante</label>
                <input type="checkbox" id="relevante">
            </div>
            <div class="modal-actions">
                <button class="save-btn" onclick="saveTrabajador()">Guardar</button>
                <button class="cancel-btn" onclick="closeModal()">Cancelar</button>
            </div>
        </div>
    </div>
    <script>
        let data = {};
        let paginaActual = 1;
        let porPagina = 6;
        let editId = null;
        let orden = "az";

        /* Generador de UUID v4 */
        function generarUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
                const r = Math.random() * 16 | 0;
                const v = c === 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        /* Render cards */
        function renderCards() {
            const cont = document.getElementById("cards-container");
            cont.innerHTML = "";
            const search = document.getElementById("search-input")?.value?.toLowerCase() || "";
            let filtrados = data.trabajadores.filter(t => t.nombre.toLowerCase().includes(search));
            if (orden === "az") { filtrados.sort((a, b) => a.nombre.localeCompare(b.nombre)); }
            else { filtrados.sort((a, b) => b.nombre.localeCompare(a.nombre)); }
            const totalPaginas = Math.ceil(filtrados.length / porPagina);
            const inicio = (paginaActual - 1) * porPagina;
            const fin = inicio + porPagina;
            const pagina = filtrados.slice(inicio, fin);
            if (pagina.length === 0) { cont.innerHTML = `<p style="width:100%;text-align:center;">No hay resultados</p>`; }
            pagina.forEach((t) => {
                cont.innerHTML += `
        <div class="card">
          <span class="category-tag">${t.categoria}</span>
          <img src="${t.imagen}" alt="${t.categoria}">
          <h3>${t.nombre}</h3>
          <p>Tel: ${t.telefono}</p>
          <p>${t.correo || ""}</p>
          <p class="relevante-label">${t.relevante ? "⭐ Contacto relevante" : ""}</p>
          <div class="actions">
            <button class="edit-btn" onclick="openModal('${t.id}')"><i class="fa fa-edit"></i></button>
            <button class="delete-btn" onclick="deleteTrabajador('${t.id}')"><i class="fa fa-trash"></i></button>
          </div>
        </div>`;
            });
            renderPaginacion(totalPaginas);
            updateOutput();
        }

        /* Paginación */
        function renderPaginacion(totalPaginas) {
            const cont = document.getElementById("paginacion");
            cont.innerHTML = "";
            if (totalPaginas <= 1) return;
            cont.innerHTML += `<button onclick="cambiarPagina(${paginaActual - 1})" ${paginaActual === 1 ? "disabled" : ""}>&laquo;</button>`;
            for (let i = 1; i <= totalPaginas; i++) {
                cont.innerHTML += `<button onclick="cambiarPagina(${i})" ${i === paginaActual ? "style='background:#a1b27a;color:#fff;'" : ""}>${i}</button>`;
            }
            cont.innerHTML += `<button onclick="cambiarPagina(${paginaActual + 1})" ${paginaActual === totalPaginas ? "disabled" : ""}>&raquo;</button>`;
        }

        function cambiarPagina(num) {
            const search = document.getElementById("search-input")?.value?.toLowerCase() || "";
            let filtrados = data.trabajadores.filter(t => t.nombre.toLowerCase().includes(search));
            const totalPaginas = Math.ceil(filtrados.length / porPagina);
            if (num < 1 || num > totalPaginas) return;
            paginaActual = num;
            renderCards();
        }
        /* Búsquedas relevantes */
        function renderBusquedas() {
            const cont = document.getElementById("busquedas-list");
            cont.innerHTML = "";
            data.busquedasRelevantes.forEach((b, i) => {
                cont.innerHTML += `
        <label>
          <input type="checkbox" ${b.activo ? "checked" : ""} onchange="toggleBusqueda(${i},this.checked)">
          ${b.categoria}
        </label><br>`;
            });
        }
        function toggleBusqueda(index, checked) {
            data.busquedasRelevantes[index].activo = checked;
            updateOutput();
        }

        /* Categorías */
        function renderCategoriasList() {
            const cont = document.getElementById("categorias-list");
            cont.innerHTML = "";
            data.categorias.forEach((cat, i) => {
                cont.innerHTML += `
        <div class="cat-row">
          <span>${cat}</span>
          <div>
            <button class="edit-cat" onclick="editCategoria(${i})"><i class="fa fa-edit"></i></button>
            <button class="delete-cat" onclick="deleteCategoria(${i})"><i class="fa fa-trash"></i></button>
          </div>
        </div>`;
            });
        }
        function addCategoria() {
            const nuevo = prompt("Nombre de la nueva categoría:");
            if (nuevo && nuevo.trim()) {
                data.categorias.push(nuevo.trim());
                renderCategoriasList();
                fillCategories();
                updateOutput();
            }
        }
        function editCategoria(index) {
            const nuevo = prompt("Nuevo nombre para la categoría:", data.categorias[index]);
            if (nuevo && nuevo.trim()) {
                const oldCat = data.categorias[index];
                data.categorias[index] = nuevo.trim();
                data.busquedasRelevantes.forEach(b => { if (b.categoria === oldCat) b.categoria = nuevo.trim(); });
                data.trabajadores.forEach(t => { if (t.categoria === oldCat) t.categoria = nuevo.trim(); });
                renderCategoriasList();
                renderBusquedas();
                fillCategories();
                renderCards();
                updateOutput();
            }
        }
        function deleteCategoria(index) {
            const cat = data.categorias[index];
            if (confirm("¿Eliminar la categoría '" + cat + "'?")) {
                data.categorias.splice(index, 1);
                data.busquedasRelevantes = data.busquedasRelevantes.filter(b => b.categoria !== cat);
                data.trabajadores.forEach(t => { if (t.categoria === cat) t.categoria = "General"; });
                renderCategoriasList();
                renderBusquedas();
                fillCategories();
                renderCards();
                updateOutput();
            }
        }

        /* Modal CRUD trabajadores */
        function openModal(id = null) {
            document.getElementById("modal").style.display = "flex";
            document.getElementById("modal-title").textContent = id === null ? "Agregar trabajador" : "Editar trabajador";
            editId = id;
            fillCategories();
            if (id !== null) {
                const t = data.trabajadores.find(x => x.id == id);
                document.getElementById("nombre").value = t.nombre;
                document.getElementById("telefono").value = t.telefono;
                document.getElementById("correo").value = t.correo;
                document.getElementById("categoria").value = t.categoria;
                document.getElementById("relevante").checked = t.relevante || false;
            } else {
                document.getElementById("nombre").value = "";
                document.getElementById("telefono").value = "";
                document.getElementById("correo").value = "";
                document.getElementById("categoria").value = data.categorias[0];
                document.getElementById("relevante").checked = false;
            }
        }

        /* Validación de campos */
        function validarCampos(nombre, telefono, correo) {
            if (!nombre) {
                alert("El nombre es obligatorio");
                return false;
            }
            if (!telefono || !/^[0-9\-]+$/.test(telefono)) {
                alert("El teléfono es obligatorio y debe tener solo números y guiones");
                return false;
            }
            if (correo && !/^[^@\s]+@[^@\s]+\.[^@\s]+$/.test(correo)) {
                alert("El correo no tiene un formato válido");
                return false;
            }
            return true;
        }

        function saveTrabajador() {
            const nombre = document.getElementById("nombre").value.trim();
            const telefono = document.getElementById("telefono").value.trim();
            const correo = document.getElementById("correo").value.trim();
            const categoria = document.getElementById("categoria").value;
            const relevante = document.getElementById("relevante").checked;

            // Validación de campos
            if (!validarCampos(nombre, telefono, correo)) {
                return;
            }

            const imagenesDisponibles = {
                "Plomero": "img/plomero.png", "Electricista": "img/electricista.png", "Carpintero": "img/carpintero.png",
                "Servicios de limpieza": "img/limpieza.png", "Jardinero": "img/jardinero.png", "Albañil": "img/trabajador.png",
                "Administrador": "img/admin.png", "Vigilancia": "img/vigilancia.png"
            };
            const imagen = imagenesDisponibles[categoria] || "img/trabajador.png";

            const nuevo = {
                id: editId || generarUUID(),
                nombre, telefono, correo, categoria, imagen, relevante
            };

            if (editId === null) {
                data.trabajadores.push(nuevo);
            } else {
                const idx = data.trabajadores.findIndex(x => x.id == editId);
                if (idx > -1) { data.trabajadores[idx] = nuevo; }
            }

            closeModal();
            renderCards();
        }
        function deleteTrabajador(id) {
            if (confirm("¿Eliminar este trabajador?")) {
                const idx = data.trabajadores.findIndex(x => x.id == id);
                if (idx > -1) {
                    data.trabajadores.splice(idx, 1);
                    renderCards();
                }
            }
        }

        function closeModal() {
            document.getElementById("modal").style.display = "none";
            editId = null;
        }

        function fillCategories() {
            const sel = document.getElementById("categoria");
            sel.innerHTML = "";
            data.categorias.forEach(cat => {
                const opt = document.createElement("option");
                opt.value = cat;
                opt.textContent = cat;
                sel.appendChild(opt);
            });
        }

        /* Exportar y copiar JSON */
        function updateOutput() {
            const out = document.getElementById("output");
            if (out) {
                out.value = JSON.stringify(data, null, 2);
            }
        }

        function downloadJSON() {
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = "directorio.json";
            a.click();
            URL.revokeObjectURL(url);
        }

        function copiarJSON() {
            const out = document.getElementById("output");
            out.select();
            document.execCommand("copy");
            alert("Datos copiados al portapapeles");
        }
        /* Cargar JSON */
        fetch('directorio.json')
            .then(r => r.json())
            .then(json => {
                data = json;
                // Asignar UUID si no existe
                data.trabajadores = data.trabajadores.map(t => ({
                    id: t.id || generarUUID(),
                    ...t
                }));
                renderCards();
                renderBusquedas();
                renderCategoriasList();
                fillCategories();
                updateOutput();
            });
    </script>


</body>

</html>
