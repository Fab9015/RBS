<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <title>Generador de Directorio</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            background: #f4f4f4;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        header {
            background: #a1b27a;
            color: white;
            padding: 10px;
            text-align: center;
        }

        header .header-actions {
            margin-top: 10px;
        }

        header .header-actions button {
            margin: 0 5px;
            padding: 6px 12px;
            border: none;
            background: #fff;
            color: #333;
            cursor: pointer;
            border-radius: 4px;
        }

        .toolbar {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            background: #eaeaea;
        }

        .container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            padding: 10px;
            flex: 1;
            overflow-y: auto;
        }

        .card {
            background: white;
            border: 1px solid #ccc;
            border-radius: 6px;
            width: 220px;
            padding: 10px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            min-height: 280px;
        }

        .card img {
            width: 100%;
            height: 120px;
            object-fit: contain;
        }

        .category-tag {
            font-size: 12px;
            background: #a1b27a;
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            margin-bottom: 5px;
            display: inline-block;
        }

        .actions {
            display: flex;
            justify-content: space-between;
            margin-top: auto;
        }

        .sidebar {
            width: 250px;
            background: #fff;
            border-left: 1px solid #ccc;
            padding: 10px;
        }

        .json-section {
            padding: 10px;
            background: #fff;
            border-top: 1px solid #ccc;
        }

        .json-section textarea {
            width: 100%;
            height: 200px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: #fff;
            padding: 20px;
            border-radius: 6px;
            width: 320px;
        }

        .modal-content label {
            display: block;
            margin: 6px 0;
        }

        /* Inputs de texto y select */
        input[type="text"],
        input[type="tel"],
        input[type="email"],
        select {
            width: 100%;
            padding: 6px;
            margin: 4px 0;
        }

        /* Checkbox corregido */
        input[type="checkbox"] {
            width: 20px;
            margin-left: 8px;
        }

        .relevante {
            display: flex;
            align-items: center;
            margin-top: 10px;
        }

        #paginacion {
            text-align: center;
            padding: 10px;
        }

        #paginacion button {
            margin: 0 2px;
            padding: 4px 8px;
        }
    </style>
</head>

<body>
    <header>
        <h1>Directorio de Trabajadores</h1>
        <div class="header-actions">
            <button onclick="openModal()">+ Crear trabajador</button>
            <button onclick="downloadJSON()">‚¨á Descargar archivo</button>
            <button onclick="copiarJSON()">üìã Copiar datos</button>
        </div>
    </header>
    <!-- Herramientas -->
    <div class="toolbar">
        <div>
            <input id="search-input" placeholder="Buscar por nombre..." oninput="renderCards()">
            <select id="orden-select" onchange="ordenarTrabajadores(this.value)">
                <option value="az">Ordenar A-Z</option>
                <option value="za">Ordenar Z-A</option>
            </select>
        </div>
        <label>
            Mostrar:
            <select onchange="porPagina=parseInt(this.value);paginaActual=1;renderCards()">
                <option value="6">6</option>
                <option value="12">12</option>
                <option value="24">24</option>
            </select>
        </label>
    </div>

    <!-- Cards -->
    <div class="container" id="cards-container"></div>

    <!-- Paginaci√≥n -->
    <div id="paginacion"></div>

    <!-- Sidebar -->
    <div class="sidebar">
        <h2>Categor√≠as
            <button class="add-cat-btn" onclick="addCategoria()">+ Agregar categor√≠a</button>
        </h2>
        <div id="categorias-list"></div>

        <h2>B√∫squedas relevantes</h2>
        <div id="busquedas-list"></div>
    </div>

    <!-- JSON generado -->
    <div class="json-section">
        <h2>JSON generado</h2>
        <textarea id="output" readonly></textarea>
    </div>
    <!-- Modal CRUD trabajadores -->
    <div class="modal" id="modal">
        <div class="modal-content">
            <h2 id="modal-title">Agregar trabajador</h2>
            <label>Nombre</label>
            <input type="text" id="nombre">

            <label>Tel√©fono</label>
            <input type="tel" id="telefono">

            <label>Correo</label>
            <input type="email" id="correo">

            <label>Categor√≠a</label>
            <select id="categoria"></select>

            <div class="relevante">
                <label for="relevante">Contacto relevante</label>
                <input type="checkbox" id="relevante">
            </div>

            <div style="margin-top:10px;display:flex;justify-content:space-between;">
                <button onclick="saveTrabajador()">Guardar</button>
                <button onclick="closeModal()">Cancelar</button>
            </div>
        </div>
    </div>
    <!-- Scripts -->
    <script>
        let data = {};
        let paginaActual = 1;
        let porPagina = 6;
        let editId = null;
        let orden = "az";

        /* Generador de UUID v4 */
        function generarUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
                const r = Math.random() * 16 | 0;
                const v = c === 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        /* Render cards */
        function renderCards() {
            const cont = document.getElementById("cards-container");
            cont.innerHTML = "";
            const search = document.getElementById("search-input")?.value?.toLowerCase() || "";
            let filtrados = data.trabajadores.filter(t => t.nombre.toLowerCase().includes(search));
            if (orden === "az") { filtrados.sort((a, b) => a.nombre.localeCompare(b.nombre)); }
            else { filtrados.sort((a, b) => b.nombre.localeCompare(a.nombre)); }
            const totalPaginas = Math.ceil(filtrados.length / porPagina);
            const inicio = (paginaActual - 1) * porPagina;
            const fin = inicio + porPagina;
            const pagina = filtrados.slice(inicio, fin);
            if (pagina.length === 0) { cont.innerHTML = `<p style="width:100%;text-align:center;">No hay resultados</p>`; }
            pagina.forEach((t) => {
                cont.innerHTML += `
          <div class="card">
            <span class="category-tag">${t.categoria}</span>
            <img src="${t.imagen}" alt="${t.categoria}">
            <h3>${t.nombre}</h3>
            <p>Tel: ${t.telefono}</p>
            <p>${t.correo || ""}</p>
            <p class="relevante-label">${t.relevante ? "‚≠ê Contacto relevante" : ""}</p>
            <div class="actions">
              <button class="edit-btn" onclick="openModal('${t.id}')"><i class="fa fa-edit"></i></button>
              <button class="delete-btn" onclick="deleteTrabajador('${t.id}')"><i class="fa fa-trash"></i></button>
            </div>
          </div>`;
            });
            renderPaginacion(totalPaginas);
            updateOutput();
        }

        /* Paginaci√≥n */
        function renderPaginacion(totalPaginas) {
            const cont = document.getElementById("paginacion");
            cont.innerHTML = "";
            if (totalPaginas <= 1) return;
            cont.innerHTML += `<button onclick="cambiarPagina(${paginaActual - 1})" ${paginaActual === 1 ? "disabled" : ""}>&laquo;</button>`;
            for (let i = 1; i <= totalPaginas; i++) {
                cont.innerHTML += `<button onclick="cambiarPagina(${i})" ${i === paginaActual ? "style='background:#a1b27a;color:#fff;'" : ""}>${i}</button>`;
            }
            cont.innerHTML += `<button onclick="cambiarPagina(${paginaActual + 1})" ${paginaActual === totalPaginas ? "disabled" : ""}>&raquo;</button>`;
        }
        function cambiarPagina(num) {
            const search = document.getElementById("search-input")?.value?.toLowerCase() || "";
            let filtrados = data.trabajadores.filter(t => t.nombre.toLowerCase().includes(search));
            const totalPaginas = Math.ceil(filtrados.length / porPagina);
            if (num < 1 || num > totalPaginas) return;
            paginaActual = num;
            renderCards();
        }

        /* B√∫squedas relevantes */
        function renderBusquedas() {
            const cont = document.getElementById("busquedas-list");
            cont.innerHTML = "";
            data.busquedasRelevantes.forEach((b, i) => {
                cont.innerHTML += `
          <label>
            <input type="checkbox" ${b.activo ? "checked" : ""} onchange="toggleBusqueda(${i},this.checked)">
            ${b.categoria}
          </label><br>`;
            });
        }
        function toggleBusqueda(index, checked) {
            data.busquedasRelevantes[index].activo = checked;
            updateOutput();
        }

        /* Categor√≠as */
        function renderCategoriasList() {
            const cont = document.getElementById("categorias-list");
            cont.innerHTML = "";
            data.categorias.forEach((cat, i) => {
                cont.innerHTML += `
          <div class="cat-row">
            <span>${cat}</span>
            <div>
              <button class="edit-cat" onclick="editCategoria(${i})"><i class="fa fa-edit"></i></button>
              <button class="delete-cat" onclick="deleteCategoria(${i})"><i class="fa fa-trash"></i></button>
            </div>
          </div>`;
            });
        }
        function addCategoria() {
            const nuevo = prompt("Nombre de la nueva categor√≠a:");
            if (nuevo && nuevo.trim()) {
                data.categorias.push(nuevo.trim());
                renderCategoriasList();
                fillCategories();
                updateOutput();
            }
        }
        function editCategoria(index) {
            const nuevo = prompt("Nuevo nombre para la categor√≠a:", data.categorias[index]);
            if (nuevo && nuevo.trim()) {
                const oldCat = data.categorias[index];
                data.categorias[index] = nuevo.trim();
                data.busquedasRelevantes.forEach(b => { if (b.categoria === oldCat) b.categoria = nuevo.trim(); });
                data.trabajadores.forEach(t => { if (t.categoria === oldCat) t.categoria = nuevo.trim(); });
                renderCategoriasList();
                renderBusquedas();
                fillCategories();
                renderCards();
                updateOutput();
            }
        }
        function deleteCategoria(index) {
            const cat = data.categorias[index];
            if (confirm("¬øEliminar la categor√≠a '" + cat + "'?")) {
                data.categorias.splice(index, 1);
                data.busquedasRelevantes = data.busquedasRelevantes.filter(b => b.categoria !== cat);
                data.trabajadores.forEach(t => { if (t.categoria === cat) t.categoria = "General"; });
                renderCategoriasList();
                renderBusquedas();
                fillCategories();
                renderCards();
                updateOutput();
            }
        }

        /* Modal CRUD trabajadores */
        function openModal(id = null) {
            document.getElementById("modal").style.display = "flex";
            document.getElementById("modal-title").textContent = id === null ? "Agregar trabajador" : "Editar trabajador";
            editId = id;
            fillCategories();
            if (id !== null) {
                const t = data.trabajadores.find(x => x.id == id);
                document.getElementById("nombre").value = t.nombre;
                document.getElementById("telefono").value = t.telefono;
                document.getElementById("correo").value = t.correo;
                document.getElementById("categoria").value = t.categoria;
                document.getElementById("relevante").checked = t.relevante || false;
            } else {
                document.getElementById("nombre").value = "";
                document.getElementById("telefono").value = "";
                document.getElementById("correo").value = "";
                document.getElementById("categoria").value = data.categorias[0];
                document.getElementById("relevante").checked = false;
            }
        }

        function saveTrabajador() {
            const nombre = document.getElementById("nombre").value.trim();
            const telefono = document.getElementById("telefono").value.trim();
            const correo = document.getElementById("correo").value.trim();
            const categoria = document.getElementById("categoria").value;
            const relevante = document.getElementById("relevante").checked;

            if (!nombre || !telefono) { alert("Nombre y tel√©fono son obligatorios"); return; }

            const imagenesDisponibles = {
                "Plomero": "img/plomero.png", "Electricista": "img/electricista.png", "Carpintero": "img/carpintero.png",
                "Servicios de limpieza": "img/limpieza.png", "Jardinero": "img/jardinero.png", "Alba√±il": "img/trabajador.png",
                "Administrador": "img/admin.png", "Vigilancia": "img/vigilancia.png"
            };
            const imagen = imagenesDisponibles[categoria] || "img/trabajador.png";

            const nuevo = {
                id: editId || generarUUID(), // üîë UUID aqu√≠
                nombre, telefono, correo, categoria, imagen, relevante
            };

            if (editId === null) {
                data.trabajadores.push(nuevo);
            } else {
                const idx = data.trabajadores.findIndex(x => x.id == editId);
                if (idx > -1) { data.trabajadores[idx] = nuevo; }
            }

            closeModal();
            renderCards();
        }

        function deleteTrabajador(id) {
            const trabajador = data.trabajadores.find(x => x.id == id);
            if (trabajador && confirm(`¬øEliminar al trabajador "${trabajador.nombre}"?`)) {
                const idx = data.trabajadores.findIndex(x => x.id == id);
                if (idx > -1) {
                    data.trabajadores.splice(idx, 1);
                    renderCards();
                }
            }
        }

        function closeModal() {
            document.getElementById("modal").style.display = "none";
            editId = null;
        }

        function fillCategories() {
            const sel = document.getElementById("categoria");
            sel.innerHTML = "";
            data.categorias.forEach(cat => {
                const opt = document.createElement("option");
                opt.value = cat;
                opt.textContent = cat;
                sel.appendChild(opt);
            });
        }

        /* Exportar y copiar JSON */
        function updateOutput() {
            const out = document.getElementById("output");
            if (out) {
                out.value = JSON.stringify(data, null, 2);
            }
        }

        function downloadJSON() {
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = "directorio.json";
            a.click();
            URL.revokeObjectURL(url);
        }

        function copiarJSON() {
            const out = document.getElementById("output");
            out.select();
            document.execCommand("copy");
            alert("Datos copiados al portapapeles");
        }

        /* Cargar JSON */
        fetch('directorio.json')
            .then(r => r.json())
            .then(json => {
                data = json;
                // Asignar UUID si no existe
                data.trabajadores = data.trabajadores.map(t => ({
                    id: t.id || generarUUID(),
                    ...t
                }));
                renderCards();
                renderBusquedas();
                renderCategoriasList();
                fillCategories();
                updateOutput();
            });
    </script>
</body>

</html>
