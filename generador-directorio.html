<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <title>Dashboard de Directorio</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <style>
        body {
            font-family: 'Lato', sans-serif;
            background: #fdfaf5;
            color: #5c4033;
            margin: 0;
        }

        header {
            background: #a1b27a;
            color: #fff;
            padding: 1em;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }

        header h1 {
            margin: 0;
        }

        header button {
            background: #fff;
            color: #5c4033;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
        }

        header button:hover {
            background: #eee;
        }

        .toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1em;
            flex-wrap: wrap;
        }

        .toolbar input,
        .toolbar select {
            padding: 6px;
            border: 1px solid #ccc;
            border-radius: 6px;
            margin-right: 8px;
        }

        .container {
            display: flex;
            flex-wrap: wrap;
            padding: 1em;
        }

        .card {
            background: #fff;
            border: 2px solid #a1b27a;
            border-radius: 8px;
            width: 280px;
            margin: 1em;
            padding: 1em;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            position: relative;
        }

        .card img {
            width: 100%;
            height: 150px;
            object-fit: contain;
        }

        .card h3 {
            margin: 0.5em 0;
        }

        .card .actions {
            display: flex;
            justify-content: space-between;
            margin-top: 0.5em;
        }

        .card button {
            flex: 1;
            margin: 0 4px;
            padding: 6px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
        }

        .edit-btn {
            background: #8fa76a;
            color: #fff;
        }

        .delete-btn {
            background: #d9534f;
            color: #fff;
        }

        .edit-btn:hover {
            background: #7a935d;
        }

        .delete-btn:hover {
            background: #c9302c;
        }

        .category-tag {
            display: inline-block;
            background: #a1b27a;
            color: #fff;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.8em;
            position: absolute;
            top: 8px;
            left: 8px;
        }

        /* Sidebar */
        .sidebar {
            padding: 1em;
            border-top: 2px solid #a1b27a;
            background: #fff;
        }

        .sidebar h2 {
            margin-top: 0;
        }

        .sidebar .cat-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 4px 0;
            padding: 4px;
            border-bottom: 1px solid #eee;
        }

        .sidebar .cat-row button {
            margin-left: 4px;
            padding: 4px 6px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8em;
        }

        .sidebar .edit-cat {
            background: #8fa76a;
            color: #fff;
        }

        .sidebar .delete-cat {
            background: #d9534f;
            color: #fff;
        }

        /* Paginación */
        #paginacion {
            text-align: center;
            margin: 1em;
        }

        #paginacion button {
            margin: 0 2px;
            padding: 6px 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        #paginacion span {
            margin: 0 4px;
        }

        /* JSON output */
        .json-section {
            padding: 1em;
            background: #fff;
            border-top: 2px solid #a1b27a;
        }

        .json-section textarea {
            width: 100%;
            height: 250px;
            font-family: monospace;
            margin-top: 1em;
        }

        .json-section button {
            margin-top: 6px;
            margin-right: 6px;
            padding: 6px 10px;
            background: #a1b27a;
            color: #fff;
            border: none;
            border-radius: 6px;
            cursor: pointer;
        }

        .json-section button:hover {
            background: #8fa76a;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: #fff;
            padding: 1.5em;
            border-radius: 8px;
            width: 400px;
            max-width: 90%;
        }

        .modal-content label {
            display: block;
            margin-top: 0.5em;
        }

        .modal-content input,
        .modal-content select {
            width: 100%;
            padding: 6px;
            margin-top: 4px;
            border: 1px solid #ccc;
            border-radius: 6px;
        }

        .modal-content .relevante {
            display: flex;
            align-items: center;
            margin-top: 0.5em;
        }

        .modal-content .relevante input {
            margin-right: 6px;
        }

        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            margin-top: 1em;
        }

        .modal-actions button {
            padding: 8px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
        }

        .modal-actions .save-btn {
            background: #a1b27a;
            color: #fff;
        }

        .modal-actions .cancel-btn {
            background: #ccc;
            color: #333;
        }

        /* Responsive */
        @media(max-width:600px) {
            .card {
                width: 100%;
            }

            .toolbar {
                flex-direction: column;
                gap: 0.5em;
            }
        }
    </style>
</head>

<body>
    <header>
        <h1>Dashboard de Directorio</h1>
        <button onclick="openModal()">+ Crear trabajador</button>
    </header>
    <!-- Herramientas -->
    <div class="toolbar">
        <div>
            <input id="search-input" placeholder="Buscar por nombre..." oninput="renderCards()">
            <select id="orden-select" onchange="ordenarTrabajadores(this.value)">
                <option value="az">Ordenar A-Z</option>
                <option value="za">Ordenar Z-A</option>
            </select>
        </div>
        <label>
            Mostrar:
            <select onchange="porPagina=parseInt(this.value);paginaActual=1;renderCards()">
                <option value="6">6</option>
                <option value="12">12</option>
                <option value="24">24</option>
            </select>
        </label>
    </div>

    <!-- Cards -->
    <div class="container" id="cards-container"></div>

    <!-- Paginación -->
    <div id="paginacion"></div>

    <!-- Sidebar -->
    <div class="sidebar">
        <h2>Categorías</h2>
        <div id="categorias-list"></div>

        <h2>Búsquedas relevantes</h2>
        <div id="busquedas-list"></div>
    </div>

    <!-- JSON generado -->
    <div class="json-section">
        <h2>JSON generado</h2>
        <textarea id="output" readonly></textarea>
        <button onclick="downloadJSON()">Descargar JSON</button>
        <button onclick="copiarJSON()">Copiar JSON</button>
    </div>
    <!-- Modal -->
    <div class="modal" id="modal">
        <div class="modal-content">
            <h2 id="modal-title">Agregar trabajador</h2>
            <label>Nombre: <input id="nombre"></label>
            <label>Teléfono: <input id="telefono"></label>
            <label>Correo: <input id="correo"></label>
            <label>Categoría:
                <select id="categoria"></select>
            </label>
            <div class="relevante">
                <input type="checkbox" id="relevante">
                <label for="relevante">Contacto relevante</label>
            </div>
            <div class="modal-actions">
                <button class="save-btn" onclick="saveTrabajador()">Guardar</button>
                <button class="cancel-btn" onclick="closeModal()">Cancelar</button>
            </div>
        </div>
    </div>
    <script>
        /* ============================
           Variables globales
        ============================ */
        let data = {};
        let paginaActual = 1;
        let porPagina = 6;
        let editIndex = null;
        let orden = "az";

        /* ============================
           Cargar directorio.json
        ============================ */
        fetch('directorio.json')
            .then(r => r.json())
            .then(json => {
                data = json;

                // Fusionar nodo "relevantes" dentro de trabajadores con atributo relevante:true
                if (data.relevantes) {
                    data.relevantes.forEach(r => {
                        data.trabajadores.push({
                            nombre: r.nombre,
                            telefono: r.telefono,
                            correo: r.correo,
                            categoria: r.categoria || "General",
                            imagen: r.imagen,
                            relevante: true
                        });
                    });
                    delete data.relevantes;
                }

                renderCards();
                renderBusquedas();
                renderCategoriasList();
                fillCategories();
                updateOutput();
            })
            .catch(err => console.error("Error al cargar directorio.json:", err));

        /* ============================
           Ordenar trabajadores
        ============================ */
        function ordenarTrabajadores(tipo) {
            orden = tipo;
            paginaActual = 1;
            renderCards();
        }
        /* ============================
           Renderizar cards
        ============================ */
        function renderCards() {
            const cont = document.getElementById("cards-container");
            cont.innerHTML = "";

            const search = document.getElementById("search-input")?.value?.toLowerCase() || "";
            let filtrados = data.trabajadores.filter(t => t.nombre.toLowerCase().includes(search));

            // Ordenar
            if (orden === "az") {
                filtrados.sort((a, b) => a.nombre.localeCompare(b.nombre));
            } else {
                filtrados.sort((a, b) => b.nombre.localeCompare(a.nombre));
            }

            const totalPaginas = Math.ceil(filtrados.length / porPagina);
            const inicio = (paginaActual - 1) * porPagina;
            const fin = inicio + porPagina;
            const pagina = filtrados.slice(inicio, fin);

            if (pagina.length === 0) {
                cont.innerHTML = `<p style="width:100%;text-align:center;">No hay resultados</p>`;
            }

            pagina.forEach((t, i) => {
                cont.innerHTML += `
      <div class="card">
        <span class="category-tag">${t.categoria}</span>
        <img src="${t.imagen}" alt="${t.categoria}">
        <h3>${t.nombre}</h3>
        <p>Tel: ${t.telefono}</p>
        <p>${t.correo || ""}</p>
        <p>${t.relevante ? "⭐ Contacto relevante" : ""}</p>
        <div class="actions">
          <button class="edit-btn" onclick="openModal(${inicio + i})"><i class="fa fa-edit"></i></button>
          <button class="delete-btn" onclick="deleteTrabajador(${inicio + i})"><i class="fa fa-trash"></i></button>
        </div>
      </div>`;
            });

            renderPaginacion(totalPaginas);
            updateOutput();
        }

        /* ============================
           Paginador inteligente
        ============================ */
        function renderPaginacion(totalPaginas) {
            const cont = document.getElementById("paginacion");
            if (!cont) return;
            cont.innerHTML = "";

            if (totalPaginas <= 1) return;

            cont.innerHTML += `<button onclick="cambiarPagina(${paginaActual - 1})" ${paginaActual === 1 ? "disabled" : ""}>&laquo;</button>`;

            if (totalPaginas <= 7) {
                for (let i = 1; i <= totalPaginas; i++) {
                    cont.innerHTML += `<button onclick="cambiarPagina(${i})" ${i === paginaActual ? "style='background:#a1b27a;color:#fff;'" : ""}>${i}</button>`;
                }
            } else {
                cont.innerHTML += `<button onclick="cambiarPagina(1)" ${paginaActual === 1 ? "style='background:#a1b27a;color:#fff;'" : ""}>1</button>`;
                cont.innerHTML += `<button onclick="cambiarPagina(2)" ${paginaActual === 2 ? "style='background:#a1b27a;color:#fff;'" : ""}>2</button>`;

                let inicio = Math.max(3, paginaActual - 2);
                let fin = Math.min(totalPaginas - 2, paginaActual + 2);

                if (inicio > 3) cont.innerHTML += "<span>...</span>";

                for (let i = inicio; i <= fin; i++) {
                    cont.innerHTML += `<button onclick="cambiarPagina(${i})" ${i === paginaActual ? "style='background:#a1b27a;color:#fff;'" : ""}>${i}</button>`;
                }

                if (fin < totalPaginas - 2) cont.innerHTML += "<span>...</span>";

                cont.innerHTML += `<button onclick="cambiarPagina(${totalPaginas - 1})" ${paginaActual === totalPaginas - 1 ? "style='background:#a1b27a;color:#fff;'" : ""}>${totalPaginas - 1}</button>`;
                cont.innerHTML += `<button onclick="cambiarPagina(${totalPaginas})" ${paginaActual === totalPaginas ? "style='background:#a1b27a;color:#fff;'" : ""}>${totalPaginas}</button>`;
            }

            cont.innerHTML += `<button onclick="cambiarPagina(${paginaActual + 1})" ${paginaActual === totalPaginas ? "disabled" : ""}>&raquo;</button>`;
        }

        function cambiarPagina(num) {
            const search = document.getElementById("search-input")?.value?.toLowerCase() || "";
            let filtrados = data.trabajadores.filter(t => t.nombre.toLowerCase().includes(search));
            const totalPaginas = Math.ceil(filtrados.length / porPagina);
            if (num < 1 || num > totalPaginas) return;
            paginaActual = num;
            renderCards();
        }

        /* ============================
           Búsquedas relevantes
        ============================ */
        function renderBusquedas() {
            const cont = document.getElementById("busquedas-list");
            if (!cont) return;
            cont.innerHTML = "";
            data.busquedasRelevantes.forEach((b, i) => {
                cont.innerHTML += `
      <label>
        <input type="checkbox" ${b.activo ? "checked" : ""} onchange="toggleBusqueda(${i},this.checked)">
        ${b.categoria}
      </label><br>`;
            });
        }

        function toggleBusqueda(index, checked) {
            data.busquedasRelevantes[index].activo = checked;
            updateOutput();
        }
        /* ============================
           Categorías con edición/eliminación
        ============================ */
        function renderCategoriasList() {
            const cont = document.getElementById("categorias-list");
            cont.innerHTML = "";
            data.categorias.forEach((cat, i) => {
                cont.innerHTML += `
      <div class="cat-row">
        <span>${cat}</span>
        <div>
          <button class="edit-cat" onclick="editCategoria(${i})"><i class="fa fa-edit"></i></button>
          <button class="delete-cat" onclick="deleteCategoria(${i})"><i class="fa fa-trash"></i></button>
        </div>
      </div>`;
            });
        }

        function editCategoria(index) {
            const nuevo = prompt("Nuevo nombre para la categoría:", data.categorias[index]);
            if (nuevo && nuevo.trim()) {
                const oldCat = data.categorias[index];
                data.categorias[index] = nuevo.trim();

                // Actualizar búsquedas relevantes
                data.busquedasRelevantes.forEach(b => {
                    if (b.categoria === oldCat) b.categoria = nuevo.trim();
                });

                // Actualizar trabajadores
                data.trabajadores.forEach(t => {
                    if (t.categoria === oldCat) t.categoria = nuevo.trim();
                });

                renderCategoriasList();
                renderBusquedas();
                fillCategories();
                renderCards();
                updateOutput();
            }
        }

        function deleteCategoria(index) {
            const cat = data.categorias[index];
            if (confirm("¿Eliminar la categoría '" + cat + "'?")) {
                data.categorias.splice(index, 1);
                data.busquedasRelevantes = data.busquedasRelevantes.filter(b => b.categoria !== cat);
                data.trabajadores.forEach(t => {
                    if (t.categoria === cat) t.categoria = "General";
                });
                renderCategoriasList();
                renderBusquedas();
                fillCategories();
                renderCards();
                updateOutput();
            }
        }

        /* ============================
           Modal CRUD trabajadores
        ============================ */
        function openModal(index = null) {
            document.getElementById("modal").style.display = "flex";
            document.getElementById("modal-title").textContent = index === null ? "Agregar trabajador" : "Editar trabajador";
            editIndex = index;

            fillCategories();

            if (index !== null) {
                const t = data.trabajadores[index];
                document.getElementById("nombre").value = t.nombre;
                document.getElementById("telefono").value = t.telefono;
                document.getElementById("correo").value = t.correo;
                document.getElementById("categoria").value = t.categoria;
                document.getElementById("relevante").checked = t.relevante || false;
            } else {
                document.getElementById("nombre").value = "";
                document.getElementById("telefono").value = "";
                document.getElementById("correo").value = "";
                document.getElementById("categoria").value = data.categorias[0];
                document.getElementById("relevante").checked = false;
            }
        }

        function saveTrabajador() {
            const nombre = document.getElementById("nombre").value.trim();
            const telefono = document.getElementById("telefono").value.trim();
            const correo = document.getElementById("correo").value.trim();
            const categoria = document.getElementById("categoria").value;
            const relevante = document.getElementById("relevante").checked;

            if (!nombre || !telefono) { alert("Nombre y teléfono son obligatorios"); return; }

            const imagenesDisponibles = {
                "Plomero": "img/plomero.png",
                "Electricista": "img/electricista.png",
                "Carpintero": "img/carpintero.png",
                "Servicios de limpieza": "img/limpieza.png",
                "Jardinero": "img/jardinero.png",
                "Albañil": "img/trabajador.png",
                "Administrador": "img/admin.png",
                "Vigilancia": "img/vigilancia.png"
            };
            const imagen = imagenesDisponibles[categoria] || "img/trabajador.png";

            const nuevo = { nombre, telefono, correo, categoria, imagen, relevante };

            if (editIndex === null) {
                data.trabajadores.push(nuevo);
            } else {
                data.trabajadores[editIndex] = nuevo;
            }

            closeModal();
            renderCards();
        }

        function deleteTrabajador(index) {
            if (confirm("¿Eliminar este trabajador?")) {
                data.trabajadores.splice(index, 1);
                renderCards();
            }
        }

        function closeModal() {
            document.getElementById("modal").style.display = "none";
            editIndex = null;
        }

        function fillCategories() {
            const sel = document.getElementById("categoria");
            sel.innerHTML = "";
            data.categorias.forEach(cat => {
                const opt = document.createElement("option");
                opt.value = cat;
                opt.textContent = cat;
                sel.appendChild(opt);
            });
        }
        /* ============================
           Exportar y copiar JSON
        ============================ */
        function updateOutput() {
            const out = document.getElementById("output");
            if (out) {
                out.value = JSON.stringify(data, null, 2);
            }
        }

        function downloadJSON() {
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = "directorio.json";
            a.click();
            URL.revokeObjectURL(url);
        }

        function copiarJSON() {
            const out = document.getElementById("output");
            out.select();
            document.execCommand("copy");
            alert("Contenido copiado al portapapeles");
        }
    </script>

</body>

</html>
